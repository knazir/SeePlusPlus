# AWS Copilot Infrastructure

This directory contains the AWS Copilot configuration for deploying the See++ application to AWS.

## Quick Start

### Automated Deployment

To deploy a complete environment (including all manual configuration steps):

```bash
# From project root
./copilot/deploy-environment.sh test   # Deploy test environment
./copilot/deploy-environment.sh prod   # Deploy production environment
```

The script will:
- ✅ Create the environment (if it doesn't exist)
- ✅ Deploy backend service
- ✅ Configure IAM roles and policies (Lambda invoke permissions)
- ✅ Set load balancer timeout to 300 seconds
- ✅ Build and deploy Lambda function (code execution)
- ✅ Set S3 bucket lifecycle policy
- ✅ Deploy frontend services
- ✅ Verify deployment

**Time estimate**: 20-25 minutes (includes Lambda Docker build and push)

### Prerequisites

Before running the deployment script, ensure you have:

1. **AWS CLI** installed and configured:
   ```bash
   aws --version
   aws sts get-caller-identity
   ```

2. **AWS Copilot CLI** installed:
   ```bash
   copilot --version
   ```

3. **Docker** installed and running:
   ```bash
   docker --version
   docker ps
   ```

4. **AWS Permissions**: Your AWS credentials must have permissions for:
   - ECS, ECR, S3, IAM, VPC, ALB, CloudFormation, SSM Parameter Store

### Safety Features

- **Non-destructive**: The script will ask for confirmation if the environment already exists
- **Idempotent**: Safe to run multiple times - will update existing resources
- **Validation**: Checks prerequisites before starting
- **Error handling**: Exits immediately on any error

## Directory Structure

```
copilot/
├── .workspace                    # Copilot application configuration
├── deploy-environment.sh         # Automated deployment script
├── README.md                     # This file
├── environments/
│   ├── test/
│   │   └── manifest.yml         # Test environment configuration
│   └── prod/
│       └── manifest.yml         # Production environment configuration
├── backend/
│   ├── manifest.yml             # Backend service configuration
│   └── addons/
│       └── trace-store.yml      # S3 bucket for execution traces
├── frontend-legacy/
│   └── manifest.yml             # Legacy frontend configuration
└── frontend/
    └── manifest.yml             # New frontend configuration
```

## Manual Deployment (Advanced)

If you prefer manual control over the deployment process, follow these steps:

### 1. Create Environment

```bash
copilot env init --name test --profile default --default-config
copilot env deploy --name test
```

### 2. Deploy Services

```bash
copilot svc deploy --name backend --env test
copilot svc deploy --name frontend-legacy --env test
copilot svc deploy --name frontend --env test
```

### 3. Manual Configuration

After deploying services, you must complete these manual steps:

1. **Configure IAM Roles** - See [deployment.md](../docs/deployment.md)
2. **Set Load Balancer Timeout** - See [deployment.md](../docs/deployment.md)
3. **Build and Deploy Lambda Function** - See [deployment.md](../docs/deployment.md)
4. **Set S3 Lifecycle** - See [deployment.md](../docs/deployment.md)

Refer to the [full deployment guide](../docs/deployment.md) for detailed instructions.

## Service Configurations

### Backend Service

- **Type**: Backend Service (internal ALB)
- **Resources**: 256 CPU, 512 MB memory
- **Scaling**: 1-10 instances based on CPU utilization
- **Port**: 8080
- **Health Check**: `/api`

### Frontend Services

Both frontends use the same resource configuration:

- **Type**: Load Balanced Web Service
- **Resources**: 256 CPU, 512 MB memory
- **Scaling**: 1-10 instances based on CPU utilization
- **Port**: 80
- **Health Check**: `/`

**frontend-legacy**: Current production frontend (React 16 + CodeMirror)
**frontend**: New modern frontend (React 19 + Monaco Editor)

### Code Runner

- **Type**: AWS Lambda function
- **Resources**: 10GB memory (scales CPU automatically)
- **Timeout**: 2 minutes
- **Platform**: Amazon Linux 2023 (x86_64)
- **Deployment**: Automated via `deploy-environment.sh` script

## Environment Differences

### Test Environment

- **Purpose**: Testing and staging
- **Scaling**: Fixed to 1 instance per service (cost optimization)
- **Deployment**: Recreate strategy for faster deployments
- **Domain**: Auto-generated by Copilot

### Production Environment

- **Purpose**: Live production traffic
- **Scaling**: Auto-scaling 1-10 instances based on CPU
- **Deployment**: Rolling updates for zero downtime
- **Domain**: Custom domain configured in manifests

## Common Operations

### View Environment Status

```bash
copilot env show --name test
copilot env show --name prod
```

### View Service Status

```bash
copilot svc status --name backend --env test
copilot svc status --name frontend-legacy --env prod
```

### View Service Logs

```bash
copilot svc logs --name backend --env test --follow
copilot svc logs --name frontend-legacy --env prod --since 1h
```

### Deploy Service Updates

```bash
# Deploy backend changes
copilot svc deploy --name backend --env prod

# Deploy frontend changes
copilot svc deploy --name frontend-legacy --env prod
```

### Delete Environment (⚠️ Destructive)

```bash
# This will delete ALL resources in the environment
copilot env delete --name test
```

## Secrets Management

Secrets are stored in AWS Systems Manager Parameter Store. The backend service requires minimal secrets since code execution is handled by Lambda:

```
/copilot/spp/{environment}/secrets/
└── ECR_REPO          # (Optional) ECR repository for frontend images
```

Lambda function configuration (function name, timeout, etc.) is managed through environment variables in the Copilot manifest.

### View Secrets

```bash
aws ssm get-parameters-by-path \
    --path "/copilot/spp/test/secrets" \
    --with-decryption
```

### Update a Secret

```bash
aws ssm put-parameter \
    --name "/copilot/spp/test/secrets/ECR_REPO" \
    --value "123456789.dkr.ecr.us-west-2.amazonaws.com/spp-frontend" \
    --type "SecureString" \
    --overwrite
```

## Troubleshooting

### Deployment Script Fails

Check the error message and:

1. Verify AWS credentials: `aws sts get-caller-identity`
2. Check Copilot version: `copilot --version` (should be v1.27+)
3. Ensure Docker is running: `docker ps`
4. Review CloudFormation events in AWS Console

### Service Health Issues

```bash
# Check service status
copilot svc status --name backend --env test

# View detailed logs
copilot svc logs --name backend --env test --since 1h

# Check ECS task status
aws ecs describe-services --cluster spp-test-Cluster --services backend
```

### Code Execution Fails

1. Check Lambda function logs:
   ```bash
   aws logs tail /aws/lambda/spp-trace-executor-test --follow
   aws logs tail /aws/lambda/spp-trace-executor-prod --follow
   ```

2. Verify Lambda function exists and is configured:
   ```bash
   aws lambda get-function --function-name spp-trace-executor-test
   aws lambda get-function-configuration --function-name spp-trace-executor-test
   ```

3. Test Lambda function directly:
   ```bash
   aws lambda invoke \
     --function-name spp-trace-executor-test \
     --payload '{"code":"int main() { return 0; }"}' \
     response.json
   ```

4. Check backend has Lambda invoke permissions:
   ```bash
   copilot svc show --name backend --env test --json | grep -A 10 "taskRole"
   ```

### Load Balancer Timeout Errors

If you see 504 Gateway Timeout errors:

```bash
# Verify ALB timeout is set to 300 seconds
aws elbv2 describe-load-balancer-attributes \
    --load-balancer-arn <your-lb-arn> \
    --query 'Attributes[?Key==`idle_timeout.timeout_seconds`]'
```

## Cost Optimization

### Minimize Costs in Test Environment

1. **Delete when not in use**:
   ```bash
   copilot env delete --name test
   ```

2. **Scale down services**:
   Edit `copilot/environments/test/manifest.yml` and set:
   ```yaml
   count: 1  # Fixed to 1 instance
   ```

3. **Stop after hours**: Use AWS Instance Scheduler to stop ECS tasks

### Monitor Costs

- Enable AWS Cost Explorer
- Set up billing alarms for unexpected charges
- Review ECS, S3, and ECR costs regularly

## Additional Resources

- **Full Deployment Guide**: [docs/deployment.md](../docs/deployment.md)
- **Infrastructure Details**: [docs/infrastructure.md](../docs/infrastructure.md)
- **Architecture Overview**: [docs/architecture.md](../docs/architecture.md)
- **Development Setup**: [docs/development.md](../docs/development.md)
- **AWS Copilot Docs**: https://aws.github.io/copilot-cli/

## Support

For issues or questions:
1. Check the [troubleshooting section](#troubleshooting) above
2. Review the [full documentation](../docs/)
3. Check AWS CloudFormation events in the console
4. Review service logs with `copilot svc logs`
